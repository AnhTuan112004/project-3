<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<div th:fragment="chat-box">
    <button class="chat-btn-toggle" onclick="toggleChat()" title="Hỗ trợ trực tuyến">
        <i class="fas fa-comments"></i>
        <span id="chat-status-dot" class="status-dot offline"></span>
    </button>

    <div class="chat-container animate__animated animate__fadeInUp" id="chatContainer">
        <div class="chat-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-headset me-2"></i>
                <span>Hỗ trợ NAT Studio</span>
                <small id="connection-text" class="d-block text-white-50" style="font-size: 0.6rem;">Đang kết nối...</small>
            </div>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message-wrapper receiver">
                <div class="message-content">
                    Xin chào! Bạn cần NAT Studio hỗ trợ thông tin gì về đặt lịch hay thiết bị không?
                </div>
                <small class="message-time">Vừa xong</small>
            </div>
        </div>

        <div class="chat-input-area p-2 bg-light">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control form-control-sm border-0 bg-white"
                       placeholder="Nhập nội dung tin nhắn..."
                       onkeypress="if(event.key === 'Enter') sendMessage()"
                       autocomplete="off">
                <button class="btn btn-primary btn-sm px-3" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div style="display: none;">
        <input type="hidden" id="current-user-name"
               th:value="${#authentication.principal != 'anonymousUser' ? #authentication.principal.fullName : 'Khách vãng lai'}">
    </div>

    <style>
        /* Nút mở chat tròn */
        .chat-btn-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10000; /* Cao hơn container */
            cursor: pointer;
        }

        .status-dot {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .status-dot.online { background-color: #28a745; }
        .status-dot.offline { background-color: #dc3545; }

        .chat-container {
            position: fixed;
            bottom: 90px; /* Cách nút một khoảng */
            right: 20px;
            width: 350px;
            height: 450px;
            z-index: 9999;
            display: flex; /* Sử dụng flex để bố cục bên trong hoạt động */
            flex-direction: column;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;

            /* TRẠNG THÁI ẨN BAN ĐẦU */
            visibility: hidden;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none; /* Không cho click khi đang ẩn */
        }

        /* TRẠNG THÁI HIỆN KHI CÓ CLASS ACTIVE */
        .chat-container.active {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto; /* Cho phép click khi hiện */
        }

        .chat-header { background-color: #0d6efd; color: white; padding: 15px; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; background-color: #f8f9fa; }

        .message-wrapper { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message-wrapper.sender { align-items: flex-end; }
        .message-wrapper.receiver { align-items: flex-start; }

        .message-content {
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 85%;
            font-size: 0.85rem;
            position: relative;
        }
        .sender .message-content { background-color: #0d6efd; color: white; border-bottom-right-radius: 2px; }
        .receiver .message-content { background-color: #e9ecef; color: #333; border-bottom-left-radius: 2px; }

        .message-time { font-size: 0.65rem; color: #999; margin-top: 2px; }
    </style>
</div>
</body>
</html>